<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="css/result_page.css">
    <link rel="icon" type="image/x-icon" href="images/logo.png">
    <title>Electric Bill Calculator - Results</title>
</head>
<body>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-section">
                <img src="images/logo.png" alt="Logo" class="logo">
                <p class="logo-text">ELBC</p>
            </div>

            <nav class="nav-menu">
                <a href="dashboard_page.html" class="nav-item">
                    <img src="images/dashboard_icon.png" alt="icon" class="nav-icon">
                    <span>Dashboard</span>
                </a>
                <a href="calculator_page.html" class="nav-item">
                    <img src="images/calculator_icon.png" alt="icon" class="nav-icon">
                    <span>Calculator</span>
                </a>
                <a href="#" class="nav-item active">
                    <img src="images/result_icon.png" alt="icon" class="nav-icon">
                    <span>Results</span>
                </a>
                <a href="profile_page.html" class="nav-item">
                    <img src="images/profile_icon.png" alt="icon" class="nav-icon">
                    <span>Profile</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">

            <div class="content-wrapper">
                
                <div class="results-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="page-title">Saved Calculations</h2>
                        <button onclick="deleteAllCalculations()" class="btn-delete-all" style="padding: 10px 20px; background-color: rgb(200, 80, 80); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                            Clear All
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table id="myTable" border="">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Consumption (kWh)</th>
                                    <th>Rate (₱/kWh)</th>
                                    <th>Total Bill (₱)</th>
                                    <th>Date</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #666; padding: 20px;">Loading data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                </div>

            </div>
        </main>
    </div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', async () => {
            const session = await initAuth();
            if (session) {
                await loadCalculations();
            }
        });

        async function loadCalculations() {
            const user = await getCurrentUser();
            if (!user) {
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('calculations')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error loading calculations:', error);
                    document.querySelector('tbody').innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: #d9534f; padding: 20px;">
                                Error loading data: ${error.message}
                            </td>
                        </tr>
                    `;
                    return;
                }

                const table = document.getElementById("myTable");
                const tbody = table.querySelector('tbody');
                
                // Clear existing rows
                tbody.innerHTML = '';

                if (data && data.length > 0) {
                    // Add each calculation as a row
                    data.forEach(calc => {
                        var row = tbody.insertRow();
                        
                        var cellMonth = row.insertCell(0);
                        var cellPowerConsumption = row.insertCell(1);
                        var cellCostPerKwh = row.insertCell(2);
                        var cellResult = row.insertCell(3);
                        var cellDate = row.insertCell(4);
                        var cellAction = row.insertCell(5);

                        // Format date
                        const date = new Date(calc.created_at);
                        const formattedDate = date.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric' 
                        });

                        cellMonth.innerHTML = calc.month;
                        cellPowerConsumption.innerHTML = parseFloat(calc.power_consumption).toFixed(2);
                        cellCostPerKwh.innerHTML = "₱ " + parseFloat(calc.cost_per_kwh).toFixed(2);
                        
                        // Use total_bill instead of result
                        cellResult.innerHTML = "₱ " + parseFloat(calc.total_bill).toFixed(2);
                        cellResult.style.fontWeight = 'bold';
                        cellResult.style.color = 'rgb(119, 139, 136)';
                        
                        cellDate.innerHTML = formattedDate;
                        cellDate.style.fontSize = '12px';
                        cellDate.style.color = '#666';

                        // Add delete button
                        cellAction.innerHTML = `
                            <button onclick="deleteCalculation(${calc.id})" 
                                    style="padding: 5px 15px; 
                                           background-color: rgb(200, 80, 80); 
                                           color: white; 
                                           border: none; 
                                           border-radius: 8px; 
                                           cursor: pointer; 
                                           font-size: 12px;
                                           font-weight: bold;">
                                Delete
                            </button>
                        `;
                        cellAction.style.textAlign = 'center';
                    });
                } else {
                    // Show empty message
                    var emptyRow = tbody.insertRow();
                    emptyRow.className = 'empty-row';
                    var emptyCell = emptyRow.insertCell(0);
                    emptyCell.colSpan = 6;
                    emptyCell.style.textAlign = 'center';
                    emptyCell.style.padding = '30px';
                    emptyCell.style.color = '#666';
                    emptyCell.innerHTML = `
                        No calculations yet. 
                        <a href="calculator_page.html" style="color: rgb(119, 139, 136); font-weight: bold;">
                            Calculate your first bill
                        </a>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                document.querySelector('tbody').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #d9534f; padding: 20px;">
                            Error loading calculations: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        async function deleteAllCalculations() {
    if (!confirm("Are you sure you want to delete ALL calculations?")) {
        return;
    }

    const user = await getCurrentUser();
    if (!user) return;

    try {
        const { error } = await supabaseClient
            .from('calculations')
            .delete()
            .eq('user_id', user.id);

        if (error) {
            alert("Error clearing all records: " + error.message);
            return;
        }

        alert("All calculations cleared!");
        await loadCalculations();

    } catch (err) {
        alert("Error: " + err.message);
    }
}

        async function deleteCalculation(id) {
    if (!confirm("Delete this calculation?")) {
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('calculations')
            .delete()
            .eq('id', Number(id)); // force ID to integer

        if (error) {
            alert("Error deleting calculation: " + error.message);
            return;
        }

        alert("Calculation deleted successfully!");
        await loadCalculations();

    } catch (error) {
        alert("Error deleting calculation: " + error.message);
    }
}

        async function handleLogout() {
            const success = await signOut();
            if (success) {
                window.location.href = 'login_page.html';
            } else {
                alert('Error logging out. Please try again.');
            }
        }
    </script>
</body>
</html>